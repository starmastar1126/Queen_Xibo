{#
/*
 * Spring Signage Ltd - http://www.springsignage.com
 * Copyright (C) 2015 Spring Signage Ltd
 * (${FILE_NAME})
 */

#}
{% extends "authed.twig" %}
{% import "inline.twig" as inline %}

{% block actionMenu %}
    <ul class="nav nav-pills pull-right">
        <li><a title="{% trans "Open the Filter Form" %}" href="{{ theme.getConfig("cms_release_notes_url") }}">{% trans "Release Notes" %}</a></li>
    </ul>
{% endblock %}

{% block pageContent %}
    {% set appName = theme.getConfig("app_name") %}
    <div class="widget">
        <div class="widget-title">{% trans %}Welcome to the {{ appName }} Upgrade{% endtrans %}</div>
        <div class="widget-body">
            <p>{% trans "The steps involved in this upgrade have been listed below, clicking the start button will run through the steps one by one." %} {% trans "Please read through the release notes before you begin as they contain important information about this new release." %}</p>
            <table class="table">
                <thead>
                    <tr>
                        <th>{% trans "Step #" %}</th>
                        <th>{% trans "Version" %}</th>
                        <th>{% trans "Step" %}</th>
                        <th>{% trans "Requested On" %}</th>
                        <th>{% trans "Complete?" %}</th>
                        <th>{% trans "Run On" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% set priorComplete = true %}
                    {% for item in steps %}
                        <tr data-step-id="{{ item.stepId }}" data-step-url="{{ urlFor("upgrade.doStep") }}">
                            <td>
                                {% if not priorComplete or item.complete %}
                                {{ item.stepId  }}
                                {% else %}
                                <button class="doStep btn btn-sm">{{ item.stepId }}</button>
                                {% endif %}
                            </td>
                            <td>{{ item.appVersion  }}</td>
                            <td>{{ item.step  }}</td>
                            <td>{{ item.requestDate|date  }}</td>
                            <td><span class="stepResult fa {% if item.complete %}fa-check{% else %}fa-times{% endif %}"></span></td>
                            <td>{% if item.lastTryDate %}{{ item.lastTryDate|date  }}{% endif %}</td>
                        </tr>
                        {% set priorComplete = item.complete %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block javaScript %}

    <script type="text/javascript">
        $(document).ready(function() {

            // Bind to the active do step button
            $("button.doStep").click(clickStep);

        });

        function clickStep(e) {
            e.preventDefault();

            var row = $(this).closest("tr");
            var stepId = row.data().stepId;
            var url = row.data().stepUrl;

            // Fire off a POST to do this step.
            $.ajax({
                method: "POST",
                url: url.replace(":id", stepId),
                dataType: "json",
                success: function (response) {
                    if (response.success) {

                        // Update the status
                        row.find("button.doStep").parent().html(stepId);
                        row.find("span.stepResult").removeClass("fa-times").addClass("fa-check").parent().next().html(moment().format(jsDateFormat));

                        // We want to move down (see if there is another step)
                        var subsequentStep = row.next();

                        if (subsequentStep.length == 0)
                            return;

                        var button = $("<button/>").addClass("doStep").addClass("btn").addClass("btn-sm").click(clickStep).html(subsequentStep.data().stepId);

                        subsequentStep.children().eq(0).html(button);
                    }
                    else {
                        toastr.error(response.message);
                    }
                },
                error: function (response) {
                    SystemMessage(response.responseText);
                }
            });
        }
    </script>

{% endblock %}